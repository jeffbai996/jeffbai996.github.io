// Prisma Schema for Republic of Praya Government Portal
// Run `npx prisma migrate dev` to create the database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  role          UserRole  @default(CITIZEN)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // PrayaPass Identity Verification
  nricNumber        String?   @unique  // National Registration ID
  identityVerified  Boolean   @default(false)
  verifiedAt        DateTime?

  // Two-Factor Authentication
  twoFactorMethod   TwoFactorMethod @default(SMS_OTP)
  twoFactorEnabled  Boolean   @default(false)
  phoneVerified     Boolean   @default(false)
  emailVerified     Boolean   @default(false)

  // Face Verification
  faceEnrolled      Boolean   @default(false)
  faceEnrolledAt    DateTime?
  faceTemplateHash  String?   // Hashed biometric template reference

  // Security
  failedAttempts    Int       @default(0)
  lockedUntil       DateTime?
  lastLoginAt       DateTime?
  passwordChangedAt DateTime?

  // Profile
  avatarUrl         String?
  dateOfBirth       DateTime?
  address           String?

  // Relations
  ctbLicenses   CtbLicense[]
  ctbTaxFilings CtbTaxFiling[]
  permits       Permit[]
  civilRequests CivilRecordRequest[]
  devices       Device[]
  sessions      Session[]
  otpCodes      OtpCode[]
  assistedUsers User[]    @relation("AssistedAccess")
  assistedBy    User?     @relation("AssistedAccess", fields: [assistedById], references: [id])
  assistedById  String?

  @@map("users")
}

model Device {
  id            String     @id @default(uuid())
  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceName    String
  deviceType    DeviceType
  fingerprint   String     @unique  // Device fingerprint for identification
  pushToken     String?    // FCM/APNs token for push notifications
  publicKey     String?    // Public key for biometric auth
  trusted       Boolean    @default(false)
  lastUsedAt    DateTime   @default(now())
  createdAt     DateTime   @default(now())

  // Relations
  sessions      Session[]

  @@map("devices")
}

model Session {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token         String    @unique
  refreshToken  String?   @unique
  deviceId      String?
  device        Device?   @relation(fields: [deviceId], references: [id])
  ipAddress     String
  userAgent     String
  expiresAt     DateTime
  lastActiveAt  DateTime  @default(now())
  createdAt     DateTime  @default(now())
  revokedAt     DateTime?

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model OtpCode {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  code        String    // Hashed OTP code
  type        OtpType
  purpose     OtpPurpose
  expiresAt   DateTime
  usedAt      DateTime?
  attempts    Int       @default(0)
  createdAt   DateTime  @default(now())

  @@index([userId, type, purpose])
  @@map("otp_codes")
}

model LoginAttempt {
  id          String    @id @default(uuid())
  email       String
  ipAddress   String
  userAgent   String
  success     Boolean
  failReason  String?
  createdAt   DateTime  @default(now())

  @@index([email])
  @@index([ipAddress])
  @@map("login_attempts")
}

enum UserRole {
  CITIZEN
  EMPLOYEE
  ADMIN
}

enum TwoFactorMethod {
  SMS_OTP
  EMAIL_OTP
  APP_BIOMETRIC
  FACE_VERIFICATION
  PUSH_NOTIFICATION
}

enum DeviceType {
  MOBILE_IOS
  MOBILE_ANDROID
  DESKTOP_BROWSER
  TABLET
}

enum OtpType {
  SMS
  EMAIL
  VOICE
}

enum OtpPurpose {
  LOGIN
  REGISTRATION
  PASSWORD_RESET
  PHONE_VERIFICATION
  EMAIL_VERIFICATION
  TRANSACTION
}

// ==================== CTB - CANNABIS TAX BUREAU ====================

model CtbLicense {
  id                 String          @id @default(uuid())
  applicationNumber  String          @unique
  type               LicenseType
  businessName       String
  ownerName          String
  address            String
  email              String
  phone              String?
  status             ApplicationStatus @default(PENDING)
  fee                Decimal         @db.Decimal(10, 2)
  submittedAt        DateTime        @default(now())
  approvedAt         DateTime?
  expiresAt          DateTime?

  // Relations
  userId             String?
  user               User?           @relation(fields: [userId], references: [id])
  taxFilings         CtbTaxFiling[]

  @@map("ctb_licenses")
}

enum LicenseType {
  CULTIVATION
  PROCESSING
  RETAIL
  TESTING
}

model CtbTaxFiling {
  id                 String          @id @default(uuid())
  confirmationNumber String          @unique
  period             String          // e.g., "Q4-2024"
  grossSales         Decimal         @db.Decimal(12, 2)
  taxableAmount      Decimal         @db.Decimal(12, 2)
  taxDue             Decimal         @db.Decimal(12, 2)
  taxPaid            Decimal?        @db.Decimal(12, 2)
  status             FilingStatus    @default(SUBMITTED)
  submittedAt        DateTime        @default(now())
  dueDate            DateTime
  paidAt             DateTime?

  // Relations
  licenseId          String
  license            CtbLicense      @relation(fields: [licenseId], references: [id])
  userId             String?
  user               User?           @relation(fields: [userId], references: [id])

  @@map("ctb_tax_filings")
}

enum FilingStatus {
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  PAID
  OVERDUE
}

// ==================== DOJ - DEPARTMENT OF JUSTICE ====================

model Court {
  id        String    @id @default(uuid())
  code      String    @unique
  name      String
  type      CourtType
  address   String
  phone     String?

  // Relations
  cases     CourtCase[]

  @@map("courts")
}

enum CourtType {
  SUPREME
  APPEALS
  DISTRICT
  MUNICIPAL
}

model CourtCase {
  id           String      @id @default(uuid())
  caseNumber   String      @unique
  title        String
  type         CaseType
  status       CaseStatus  @default(PENDING)
  filedDate    DateTime
  closedDate   DateTime?
  nextHearing  DateTime?
  judge        String?

  // Relations
  courtId      String
  court        Court       @relation(fields: [courtId], references: [id])

  @@map("court_cases")
}

enum CaseType {
  CIVIL
  CRIMINAL
  FAMILY
  TRAFFIC
  SMALL_CLAIMS
}

enum CaseStatus {
  PENDING
  ACTIVE
  ON_HOLD
  SETTLED
  CLOSED
  DISMISSED
}

// ==================== INTERIOR DEPARTMENT ====================

model LandRecord {
  id             String    @id @default(uuid())
  parcelNumber   String    @unique
  address        String
  owner          String
  area           Decimal   @db.Decimal(12, 2)
  areaUnit       String    @default("sqm")
  zoning         ZoningType
  registeredDate DateTime
  lastTransfer   DateTime?

  // Relations
  permits        Permit[]

  @@map("land_records")
}

enum ZoningType {
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
  AGRICULTURAL
  MIXED_USE
  PROTECTED
}

model Permit {
  id               String          @id @default(uuid())
  permitNumber     String          @unique
  type             PermitType
  description      String
  ownerName        String
  email            String
  phone            String?
  status           ApplicationStatus @default(PENDING)
  fee              Decimal         @db.Decimal(10, 2)
  submittedAt      DateTime        @default(now())
  approvedAt       DateTime?
  expiresAt        DateTime?

  // Relations
  parcelNumber     String
  landRecord       LandRecord      @relation(fields: [parcelNumber], references: [parcelNumber])
  userId           String?
  user             User?           @relation(fields: [userId], references: [id])

  @@map("permits")
}

enum PermitType {
  NEW_CONSTRUCTION
  RENOVATION
  DEMOLITION
  ZONING_VARIANCE
}

model CivilRecordRequest {
  id               String          @id @default(uuid())
  requestNumber    String          @unique
  type             CivilRecordType
  firstName        String
  lastName         String
  dateOfEvent      DateTime
  purpose          String?
  email            String
  status           ApplicationStatus @default(PENDING)
  submittedAt      DateTime        @default(now())
  completedAt      DateTime?

  // Relations
  userId           String?
  user             User?           @relation(fields: [userId], references: [id])

  @@map("civil_record_requests")
}

enum CivilRecordType {
  BIRTH
  DEATH
  MARRIAGE
  DIVORCE
  NAME_CHANGE
}

model Park {
  id        String  @id @default(uuid())
  code      String  @unique
  name      String
  area      Int     // hectares
  visitors  Int     @default(0) // annual visitors

  @@map("parks")
}

// ==================== SHARED ====================

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
}
